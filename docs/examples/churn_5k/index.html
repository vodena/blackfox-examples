<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.0 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Churn Example with 5k data - BlackFox examples</title>
<meta name="description" content="">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="BlackFox examples">
<meta property="og:title" content="Churn Example with 5k data">
<meta property="og:url" content="/blackfox-examples/examples/churn_5k/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2019-04-25T11:09:43+02:00">






<link rel="canonical" href="/blackfox-examples/examples/churn_5k/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "VodÃ©na",
      "url": null,
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/blackfox-examples/feed.xml" type="application/atom+xml" rel="alternate" title="BlackFox examples Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blackfox-examples/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--example wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/blackfox-examples/"><img src="/blackfox-examples/assets/images/apple-touch-icon.png" alt=""></a>
        
        <a class="site-title" href="/blackfox-examples/">BlackFox Examples</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blackfox-examples/posts/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/blackfox-examples/examples/" >Examples</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    
    <!-- <meta itemprop="headline" content="Churn Example with 5k data"> -->
    
    
    <!-- <meta itemprop="description" content=""> -->
    
    
    

    <div class="page__inner-wrap">
      
      <!-- <header>
        <h1 id="page-title" class="page__title" itemprop="headline">
          Churn Example with 5k data
</h1>
        
      </header> -->
      

      <section class="page__content" itemprop="text">
        

        


        <div>

          
<h1 id="churn">Churn</h1>

<h3 id="problem-explanation">Problem explanation:</h3>

<p>The customer churn, also known as customer attrition, refers to the phenomenon whereby <strong>a customer leaves a company</strong>. Some studies confirmed that acquiring new customers can cost five times more than satisfying and retaining existing customers. As a matter of fact, there are a lot of benefits that encourage the tracking of the customer churn rate, for example, marketing costs to acquire new customers are high. Therefore, it is important to retain customers so that the initial investment is not wasted, It has a direct impact on the ability to expand the company, etc.</p>

<p>A bank is investigating a very high rate of customer leaving the bank. Here is a 10000 records data set to investigate and predict which of the customers are more likely to leave the bank soon.</p>

<p>This is classification problem and the results are two outputs, customer will leave the bank or he will not. Model inputs are:</p>

<ul>
  <li>Credit score,</li>
  <li>Geography,</li>
  <li>Gender,</li>
  <li>Age,</li>
  <li>Tenure,</li>
  <li>Balance,</li>
  <li>Number of products,</li>
  <li>Has credit card,</li>
  <li>Is active member,</li>
  <li>Estimated salary.</li>
</ul>

<h3 id="problem-solution">Problem solution:</h3>
<p>The entire data set contains 10000 observations. We divide it into two sets, training set, which contains 8000 observations and test set, which contains 2000 observations. We solved problem in three ways:</p>

<ul>
  <li>Manually buiilding ANN,</li>
  <li>Tune some hyperparameters by using grid search and</li>
  <li>Employing Black Fox service.</li>
</ul>

<p>We evaluate the performance of the models using K-fold cross validation. For the purpose of feature scaling, we apply a min max scaler. The independent variables geography and gender are features that are strings so we have to apply label encoder to encode text into numbers and then we can encode geography by one hot encoder. In order to avoid dummy variable trap, for geography we ignored for example feature Germany. To stop the training at the right time, Kerasâ€™ early stopping scheme is applied.</p>

<h3 id="update-keras-to-latest-version">Update Keras to latest version</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">keras</span><span class="o">==</span><span class="mf">2.2.4</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Collecting keras==2.2.4
[?25l  Downloading https://files.pythonhosted.org/packages/5e/10/aa32dad071ce52b5502266b5c659451cfd6ffcbf14e6c8c4f16c0ff5aaab/Keras-2.2.4-py2.py3-none-any.whl (312kB)
[K    100% |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 317kB 13.9MB/s ta 0:00:01
[?25hRequirement already satisfied: keras-preprocessing&gt;=1.0.5 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (1.0.9)
Requirement already satisfied: scipy&gt;=0.14 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (1.1.0)
Requirement already satisfied: h5py in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (2.8.0)
Requirement already satisfied: six&gt;=1.9.0 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (1.11.0)
Requirement already satisfied: pyyaml in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (3.13)
Requirement already satisfied: keras-applications&gt;=1.0.6 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (1.0.7)
Requirement already satisfied: numpy&gt;=1.9.1 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from keras==2.2.4) (1.14.6)
Installing collected packages: keras
  Found existing installation: Keras 2.2.2
    Uninstalling Keras-2.2.2:
      Successfully uninstalled Keras-2.2.2
Successfully installed keras-2.2.4
[33mYou are using pip version 19.0.3, however version 19.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.[0m
</code></pre></div></div>

<h1 id="data-preprocessing">Data preprocessing</h1>
<h4 id="importing-data-frame">Importing data frame</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Importing the libraries
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>

<span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'Churn_5k.csv'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="dataset-info">Dataset info</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataframe</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 5000 entries, 0 to 4999
Data columns (total 14 columns):
RowNumber          5000 non-null int64
CustomerId         5000 non-null int64
Surname            5000 non-null object
CreditScore        5000 non-null int64
Geography          5000 non-null object
Gender             5000 non-null object
Age                5000 non-null int64
Tenure             5000 non-null int64
Balance            5000 non-null float64
NumOfProducts      5000 non-null int64
HasCrCard          5000 non-null int64
IsActiveMember     5000 non-null int64
EstimatedSalary    5000 non-null float64
Exited             5000 non-null int64
dtypes: float64(2), int64(9), object(3)
memory usage: 547.0+ KB
</code></pre></div></div>

<h4 id="dataset-description">Dataset description</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataframe</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RowNumber</th>
      <th>CustomerId</th>
      <th>CreditScore</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Exited</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>5000.000000</td>
      <td>5.000000e+03</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
      <td>5000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>5037.136200</td>
      <td>1.569135e+07</td>
      <td>651.229200</td>
      <td>38.859400</td>
      <td>4.973800</td>
      <td>76635.872688</td>
      <td>1.529200</td>
      <td>0.709200</td>
      <td>0.518400</td>
      <td>100401.897116</td>
      <td>0.202000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2870.860248</td>
      <td>7.216109e+04</td>
      <td>96.177839</td>
      <td>10.513636</td>
      <td>2.894407</td>
      <td>62534.011985</td>
      <td>0.572724</td>
      <td>0.454177</td>
      <td>0.499711</td>
      <td>57887.016029</td>
      <td>0.401532</td>
    </tr>
    <tr>
      <th>min</th>
      <td>5.000000</td>
      <td>1.556571e+07</td>
      <td>350.000000</td>
      <td>18.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>90.070000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2590.750000</td>
      <td>1.562831e+07</td>
      <td>584.000000</td>
      <td>32.000000</td>
      <td>2.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>50781.767500</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>5027.000000</td>
      <td>1.569014e+07</td>
      <td>653.000000</td>
      <td>37.000000</td>
      <td>5.000000</td>
      <td>97145.940000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>100399.670000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>7527.500000</td>
      <td>1.575503e+07</td>
      <td>718.000000</td>
      <td>44.000000</td>
      <td>7.000000</td>
      <td>127846.872500</td>
      <td>2.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>150581.287500</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>9999.000000</td>
      <td>1.581566e+07</td>
      <td>850.000000</td>
      <td>92.000000</td>
      <td>10.000000</td>
      <td>222267.630000</td>
      <td>4.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>199970.740000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="histograms-of-the-numerical-features">Histograms of the numerical features</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataframe</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_10_0.png" alt="png" /></p>

<h4 id="corelation-heatmap">Corelation heatmap</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_12_0.png" alt="png" /></p>

<h4 id="separate-the-data-frame-into-feature-matrix-x-and-dependent-variable-y">Separate the data frame into feature matrix X and dependent variable y</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></div>

<h4 id="encode-the-categorical-variables-in-our-feature-matrix">Encode the categorical variables in our feature matrix</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="n">labelencoder_X_1</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># Encoding geography( countries )
</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelencoder_X_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">labelencoder_X_2</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># Encoding gender
</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelencoder_X_2</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># OneHotEncoding the countries to make dummy variables for this categorical variable.
</span><span class="n">onehotencoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">onehotencoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

<span class="c1"># To avoid dummy variable trap we remove for example countre Germany.
</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</code></pre></div></div>

<h4 id="split-the-entire-data-set-into-the-training-set-and-test-set">Split the entire data set into the training set and test set</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="apply-the-feature-scaling-because-we-dont-wanna-have-any-feature-dominating-another-feature">Apply the feature scaling because we donâ€™t wanna have any feature dominating another feature</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Min-max scaler
</span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">X_train_minMaxScaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_minMaxScaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="option-1---manually-build-ann-using-keras">Option 1 - manually build ANN using Keras</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Importing the keras libraries and packages
</span><span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">Callback</span><span class="p">,</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">,</span> <span class="n">input_dim</span> <span class="o">=</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">))</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">))</span>
<span class="n">es</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s">'val_loss'</span><span class="p">,</span>
                   <span class="n">mode</span> <span class="o">=</span> <span class="s">'auto'</span><span class="p">,</span>
                   <span class="c1">#min_delta = 0,
</span>                   <span class="n">patience</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                   <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="c1">#baseline=0.4,
</span>                   <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="p">)</span>
<span class="n">classifier</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s">'adam'</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="s">'binary_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">X_train_minMaxScaled</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">es</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">end1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">time1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end1</span><span class="o">-</span><span class="n">start1</span><span class="p">)</span>
<span class="n">minutes1</span><span class="p">,</span> <span class="n">seconds1</span><span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">hours1</span><span class="p">,</span> <span class="n">minutes1</span><span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Train on 2800 samples, validate on 1200 samples
Epoch 1/3000
2800/2800 [==============================] - 7s 3ms/step - loss: 0.6566 - acc: 0.7296 - val_loss: 0.6117 - val_acc: 0.7942
Epoch 2/3000
2800/2800 [==============================] - 0s 111us/step - loss: 0.5705 - acc: 0.8018 - val_loss: 0.5415 - val_acc: 0.7942
Epoch 3/3000
2800/2800 [==============================] - 0s 112us/step - loss: 0.5174 - acc: 0.8018 - val_loss: 0.5134 - val_acc: 0.7942
.
.
.
Epoch 1048/3000
2800/2800 [==============================] - 0s 112us/step - loss: 0.3899 - acc: 0.8389 - val_loss: 0.4116 - val_acc: 0.8342
Epoch 1049/3000
2800/2800 [==============================] - 0s 128us/step - loss: 0.3904 - acc: 0.8350 - val_loss: 0.4117 - val_acc: 0.8342
Epoch 1050/3000
2800/2800 [==============================] - 0s 124us/step - loss: 0.3900 - acc: 0.8357 - val_loss: 0.4117 - val_acc: 0.8325
Restoring model weights from the end of the best epoch
Epoch 01050: early stopping
</code></pre></div></div>

<h4 id="plot-loss-during-training">Plot loss during training</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'train'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'blue'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'validation'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_24_0.png" alt="png" /></p>

<h4 id="plot-accuracy-during-training">Plot accuracy during training</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'acc'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'train'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'blue'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_acc'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'validation'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_26_0.png" alt="png" /></p>

<h4 id="we-just-trained-our-artificial-neural-network-on-the-training-set-and-now-its-time-to-make-the-prediction-on-the-test-set">We just trained our artificial neural network on the training set and now itâ€™s time to make the prediction on the test set</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_pred_trained</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_minMaxScaled</span><span class="p">)</span>

<span class="n">y_pred_for_confusionMatrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_trained</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_pred_trained</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_pred_for_confusionMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_pred_for_confusionMatrix</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_test_for_confusionMatrix</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_for_confusionMatrix</span><span class="p">)</span>

<span class="n">errorOnTestSetTrained</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Time to manually train one network is "</span><span class="p">,</span> <span class="n">time1</span><span class="p">,</span><span class="s">"seconds("</span><span class="p">,</span><span class="n">hours1</span><span class="p">,</span><span class="s">"hours,"</span><span class="p">,</span><span class="n">minutes1</span><span class="p">,</span><span class="s">"minutes and "</span><span class="p">,</span><span class="n">seconds1</span><span class="p">,</span><span class="s">"seconds )."</span><span class="p">)</span>

<span class="c1"># CONFUSION MATRIX IMAGE
</span><span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                          <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Normalized confusion matrix'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Confusion matrix, without normalization'</span>

    <span class="c1"># Compute confusion matrix
</span>    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="c1"># Only use the labels that appear in the data
</span>    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float'</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#print("Normalized confusion matrix")
</span>    <span class="c1">#else:
</span>        <span class="c1">#print('Confusion matrix, without normalization')
</span>
    <span class="c1">#print(cm)
</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
    
    <span class="c1"># We want to show all ticks...
</span>    <span class="n">ax</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
           <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
           <span class="c1"># ... and label them with the respective list entries
</span>           <span class="n">xticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s">'True label'</span><span class="p">,</span>
           <span class="n">xlabel</span><span class="o">=</span><span class="s">'Predicted label'</span><span class="p">)</span>

    <span class="c1"># Rotate the tick labels and set their alignment.
</span>    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">"right"</span><span class="p">,</span>
             <span class="n">rotation_mode</span><span class="o">=</span><span class="s">"anchor"</span><span class="p">)</span>

    <span class="c1"># Loop over data dimensions and create text annotations.
</span>    <span class="n">fmt</span> <span class="o">=</span> <span class="s">'.2f'</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s">'d'</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fmt</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s">"white"</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="s">"black"</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
<span class="c1"># Plot non-normalized confusion matrix
</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_for_confusionMatrix</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Confusion matrix'</span><span class="p">);</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Test set error, which we can read in confusion matrix is"</span><span class="p">,</span><span class="n">errorOnTestSetTrained</span><span class="p">,</span><span class="s">"</span><span class="si">%</span><span class="s">."</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time to manually train one network is  377 seconds( 0 hours, 6 minutes and  17 seconds ).

Test set error, which we can read in confusion matrix is 17.6 %.
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_28_1.png" alt="png" /></p>

<h4 id="roc-curve-and-auc">ROC curve and AUC</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># calculate AUC
</span><span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_trained</span><span class="p">)</span>
<span class="c1"># calculate roc curve
</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_trained</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Random ROC'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Manual ROC (AUC = </span><span class="si">%.3</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'ROC Curve'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'False Posive rate (FPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'True Posive rate (TPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s">'lower right'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_30_0.png" alt="png" /></p>

<h1 id="option-2---parameter-tuning-by-grid-search">Option 2 - Parameter tuning by Grid search</h1>
<p>We have two type of model parameters, <strong>the weights</strong> obtained during training process, and parameters that stay fixed, called the <strong>hyperparameters</strong>. The examples of th hyperparameters are <strong>number of epochs</strong>, <strong>batch size</strong>, <strong>type of optimizer</strong>, <strong>number of layers</strong>, <strong>the number of neurons layers</strong> etc. The ANN trained in <strong>Option 1</strong> used fixed values of these hyperparameters, but perhaps some other values would lead us to a better accuracy.</p>

<p>The parameter tuning is all about finding the best values of the hyperparameters. We will try this using a simple technique called <strong>Grid search</strong> that will test several combinations of hyperparameter and return the best choice that leads to the best accuracy obtained by K-fold cross validation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.wrappers.scikit_learn</span> <span class="kn">import</span> <span class="n">KerasClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">start2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">build_classifier</span><span class="p">(</span><span class="n">optimizer</span><span class="p">):</span>
   <span class="n">classifier</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
   <span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">,</span> <span class="n">input_dim</span> <span class="o">=</span> <span class="mi">11</span><span class="p">))</span>
   <span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">))</span>
   <span class="n">classifier</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s">'uniform'</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'sigmoid'</span><span class="p">))</span>
   <span class="n">classifier</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="s">'binary_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
   <span class="k">return</span> <span class="n">classifier</span>

<span class="n">Tuning_classifier</span> <span class="o">=</span> <span class="n">KerasClassifier</span><span class="p">(</span><span class="n">build_fn</span> <span class="o">=</span> <span class="n">build_classifier</span><span class="p">)</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">'batch_size'</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> 
              <span class="s">'epochs'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3000</span><span class="p">],</span>
              <span class="s">'optimizer'</span><span class="p">:</span> <span class="p">[</span><span class="s">'adam'</span><span class="p">,</span> <span class="s">'adadelta'</span><span class="p">]</span>
             <span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">Tuning_classifier</span><span class="p">,</span>
                           <span class="n">param_grid</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">,</span>
                           <span class="c1">#scoring = 'accuracy',
</span>                           <span class="n">cv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                          <span class="p">)</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_minMaxScaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">best_parameters</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
<span class="n">best_accuracy</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Best parameters are :</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">best_parameters</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Best accuracy is :</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">best_accuracy</span><span class="p">)</span>


<span class="n">end2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">time2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end2</span><span class="o">-</span><span class="n">start2</span><span class="p">)</span>
<span class="n">minutes2</span><span class="p">,</span> <span class="n">seconds2</span><span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">time2</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">hours2</span><span class="p">,</span> <span class="n">minutes2</span><span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minutes2</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Epoch 1/3000
2000/2000 [==============================] - 5s 2ms/step - loss: 0.6657 - acc: 0.7315
Epoch 2/3000
2000/2000 [==============================] - 0s 81us/step - loss: 0.5979 - acc: 0.8065
Epoch 3/3000
2000/2000 [==============================] - 0s 83us/step - loss: 0.5420 - acc: 0.8065
.
.
.

Epoch 2998/3000
4000/4000 [==============================] - 0s 41us/step - loss: 0.3827 - acc: 0.8375
Epoch 2999/3000
4000/4000 [==============================] - 0s 41us/step - loss: 0.3827 - acc: 0.8375
Epoch 3000/3000
4000/4000 [==============================] - 0s 41us/step - loss: 0.3827 - acc: 0.8375
Best parameters are :
 {'batch_size': 64, 'epochs': 3000, 'optimizer': 'adadelta'}

Best accuracy is :
 0.82875
</code></pre></div></div>

<h4 id="our-optimized-ann-resides-in-grid_search-now-its-time-to-make-the-prediction-on-the-test-set">Our optimized ANN resides in grid_search. Now itâ€™s time to make the prediction on the test set</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_pred_tuning</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_minMaxScaled</span><span class="p">)</span>
<span class="n">y_pred_tuning</span> <span class="o">=</span> <span class="n">y_pred_tuning</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_pred_tuning</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>

<span class="n">y_pred_tuning_for_confusionMatrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_tuning</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_pred_tuning</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_pred_tuning_for_confusionMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_pred_tuning_for_confusionMatrix</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_test_for_confusionMatrix</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_tuning_for_confusionMatrix</span><span class="p">)</span>

<span class="n">errorOnTestSetTuning</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Time needed for tuning is "</span><span class="p">,</span> <span class="n">time2</span><span class="p">,</span><span class="s">"seconds("</span><span class="p">,</span><span class="n">hours2</span><span class="p">,</span><span class="s">"hours,"</span><span class="p">,</span><span class="n">minutes2</span><span class="p">,</span><span class="s">"minutes and "</span><span class="p">,</span><span class="n">seconds2</span><span class="p">,</span><span class="s">"seconds)."</span><span class="p">)</span>

<span class="c1"># CONFUSION MATRIX IMAGE
</span><span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                          <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Normalized confusion matrix'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Confusion matrix, without normalization'</span>

    <span class="c1"># Compute confusion matrix
</span>    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="c1"># Only use the labels that appear in the data
</span>    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float'</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#print("Normalized confusion matrix")
</span>    <span class="c1">#else:
</span>        <span class="c1">#print('Confusion matrix, without normalization')
</span>
    <span class="c1">#print(cm)
</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
    
    <span class="c1"># We want to show all ticks...
</span>    <span class="n">ax</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
           <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
           <span class="c1"># ... and label them with the respective list entries
</span>           <span class="n">xticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s">'True label'</span><span class="p">,</span>
           <span class="n">xlabel</span><span class="o">=</span><span class="s">'Predicted label'</span><span class="p">)</span>

    <span class="c1"># Rotate the tick labels and set their alignment.
</span>    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">"right"</span><span class="p">,</span>
             <span class="n">rotation_mode</span><span class="o">=</span><span class="s">"anchor"</span><span class="p">)</span>

    <span class="c1"># Loop over data dimensions and create text annotations.
</span>    <span class="n">fmt</span> <span class="o">=</span> <span class="s">'.2f'</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s">'d'</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fmt</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s">"white"</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="s">"black"</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
<span class="c1"># Plot non-normalized confusion matrix
</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_tuning_for_confusionMatrix</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Confusion matrix'</span><span class="p">);</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Test set error with tuning, which we can read in confusion matrix is"</span><span class="p">,</span><span class="n">errorOnTestSetTuning</span><span class="p">,</span><span class="s">"</span><span class="si">%</span><span class="s">."</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time needed for tuning is  19820 seconds( 5 hours, 30 minutes and  20 seconds).

Test set error with tuning, which we can read in confusion matrix is 17.4 %.
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_34_1.png" alt="png" /></p>

<h4 id="roc-curve-and-auc-1">ROC curve and AUC</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># calculate AUC
</span><span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tuning</span><span class="p">)</span>
<span class="c1"># calculate roc curve
</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tuning</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Random ROC'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Tuning ROC (AUC = </span><span class="si">%.3</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'ROC Curve'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'False Posive rate (FPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'True Posive rate (TPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s">'lower right'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_36_0.png" alt="png" /></p>

<h1 id="option-3---optimize-ann-using-black-fox-service">Option 3 - Optimize ANN using Black Fox service</h1>

<h4 id="install-black-fox-service">Install Black fox service</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">blackfox</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Collecting blackfox
[?25l  Downloading https://files.pythonhosted.org/packages/d8/38/94ed8bfac47306f510ba6c14dd5e18199536329c3c76b955399bb87b0c22/blackfox-0.0.3-py3-none-any.whl (45kB)
[K    100% |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 51kB 2.7MB/s ta 0:00:011
[?25hRequirement already satisfied: six&gt;=1.10 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from blackfox) (1.11.0)
Requirement already satisfied: python-dateutil in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from blackfox) (2.7.5)
Requirement already satisfied: certifi in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from blackfox) (2018.10.15)
Requirement already satisfied: urllib3&gt;=1.15 in /home/nbuser/anaconda3_501/lib/python3.6/site-packages (from blackfox) (1.23)
Installing collected packages: blackfox
Successfully installed blackfox-0.0.3
[33mYou are using pip version 19.0.3, however version 19.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.[0m
</code></pre></div></div>

<h4 id="lets-run-the-black-fox-service-to-find-best-ann-for-the-specific-problem-note-that-we-optimize-the-architecture-as-well">Letâ€™s run the Black Fox service to find best ANN for the specific problem. Note that we optimize the architecture, as well!</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Importing the BF service libraries and other libraries
</span><span class="kn">from</span> <span class="nn">blackfox</span> <span class="kn">import</span> <span class="n">BlackFox</span>
<span class="kn">from</span> <span class="nn">blackfox</span> <span class="kn">import</span> <span class="n">KerasOptimizationConfig</span>
<span class="kn">from</span> <span class="nn">blackfox</span> <span class="kn">import</span> <span class="n">OptimizationEngineConfig</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="c1">#from keras.models import load_model
#import numpy as np
#import pandas as pd
</span>
<span class="n">blackfox_url</span> <span class="o">=</span> <span class="s">'http://*******************'</span>
<span class="n">bf</span> <span class="o">=</span> <span class="n">BlackFox</span><span class="p">(</span><span class="n">blackfox_url</span><span class="p">)</span>

<span class="n">ec</span> <span class="o">=</span> <span class="n">OptimizationEngineConfig</span><span class="p">(</span><span class="n">proc_timeout_miliseconds</span><span class="o">=</span><span class="mi">2000000</span><span class="p">,</span> <span class="n">population_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_num_of_generations</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">KerasOptimizationConfig</span><span class="p">(</span><span class="n">engine_config</span><span class="o">=</span><span class="n">ec</span><span class="p">,</span> <span class="n">max_epoch</span> <span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">problem_type</span><span class="o">=</span><span class="s">"BinaryClassification"</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="n">start3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Use CTRL + C to stop optimization
</span><span class="p">(</span><span class="n">ann_io</span><span class="p">,</span> <span class="n">ann_info</span><span class="p">,</span> <span class="n">ann_metadata</span><span class="p">)</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">optimize_keras_sync</span><span class="p">(</span>
    <span class="n">input_set</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">,</span>
    <span class="n">output_set</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">,</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
    <span class="n">integrate_scaler</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">network_path</span><span class="o">=</span><span class="s">'OptimizedANNChurn_5k_1.h5'</span>
<span class="p">)</span>

<span class="n">end3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end3</span><span class="o">-</span><span class="n">start3</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">ann info:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ann_info</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">ann metadata:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ann_metadata</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Use CTRL + C to stop optimization
Uploading data set
Starting...
2019-04-25 06:25:52.566953 -&gt; Active, Generation: 0/20, Validation set error: 0.000000, Training set error: 0.000000, Epoch: 0, Optimization Id: bc0beade-8f20-44e4-8988-57939408880a
2019-04-25 06:43:36.994987 -&gt; Active, Generation: 1/20, Validation set error: 0.351420, Training set error: 0.353619, Epoch: 113, Optimization Id: bc0beade-8f20-44e4-8988-57939408880a
.
.
.
2019-04-25 08:00:14.384631 -&gt; Stopped, Generation: 19/20, Validation set error: 0.350685, Training set error: 0.330486, Epoch: 1025, Optimization Id: bc0beade-8f20-44e4-8988-57939408880a
stopped Stopped
Downloading network becd7ab836489a7d3af0e713891e28fdd15bb1d1
Saving network becd7ab836489a7d3af0e713891e28fdd15bb1d1 to OptimizedANNChurn_With5k.h5

ann info:
{'dropout': 0.07,
 'hidden_layers': [{'activation_function': 'selu', 'neuron_count': 10}],
 'id': 'becd7ab836489a7d3af0e713891e28fdd15bb1d1',
 'output_layer_activation_function': 'Sigmoid',
 'training_algorithm': 'Nadam'}

ann metadata:
{'__version': 1, 'is_scaler_integrated': False, 'scaler_config': {'input': {'feature_range': [-1, 1], 'fit': [[0.0, 0.0, 350.0, 0.0, 18.0, 0.0, 0.0, 1.0, 0.0, 0.0, 90.07], [1.0, 1.0, 850.0, 1.0, 92.0, 10.0, 222267.63, 4.0, 1.0, 1.0, 199970.74]], 'inverse_transform': False}, 'output': {'feature_range': [0, 1], 'fit': [[0.0], [1.0]], 'inverse_transform': True}}, 'scaler_name': 'MinMaxScaler'}
</code></pre></div></div>

<h4 id="the-data-set-passed-to-the-black-fox-service-was-not-scaled-since-black-fox-scales-inputs-automatically-in-order-to-apply-obtained-ann-in-prediction-blackfox-offers-the-utility-function-to-scale-our-test-set-the-same-way">The data set passed to the Black Fox service was not scaled since Black Fox scales inputs automatically. In order to apply obtained ANN in prediction, BlackFox offers the utility function to scale our test set the same way.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get metadata
</span><span class="n">meta</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s">'OptimizedANNChurn_5k_1.h5'</span><span class="p">)</span>
<span class="n">scaler_config</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s">'scaler_config'</span><span class="p">]</span>

<span class="c1"># Scale
</span><span class="n">x_scaler_config</span> <span class="o">=</span> <span class="n">scaler_config</span><span class="p">[</span><span class="s">'input'</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span> 
<span class="n">min_max_x</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="n">x_scaler_config</span><span class="p">[</span><span class="s">'feature_range'</span><span class="p">])</span>
<span class="n">min_max_x</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_scaler_config</span><span class="p">[</span><span class="s">'fit'</span><span class="p">])</span>

<span class="n">X_test_minMaxScaled_withBF</span> <span class="o">=</span> <span class="n">min_max_x</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="prediction-using-ann-proposed-by-black-fox">Prediction using ANN proposed by Black Fox</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Importing ANN model
</span><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s">'OptimizedANNChurn_5k_1.h5'</span><span class="p">)</span>

<span class="c1"># Predicted values
</span><span class="n">y_pred_BF</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_minMaxScaled_withBF</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="rescale">Rescale</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Rescale
</span><span class="n">y_scaler_config</span> <span class="o">=</span> <span class="n">scaler_config</span><span class="p">[</span><span class="s">'output'</span><span class="p">]</span>
<span class="n">min_max_y</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="n">y_scaler_config</span><span class="p">[</span><span class="s">'feature_range'</span><span class="p">])</span>
<span class="n">min_max_y</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y_scaler_config</span><span class="p">[</span><span class="s">'fit'</span><span class="p">])</span>

<span class="n">y_pred_BF_realValues</span> <span class="o">=</span> <span class="n">min_max_y</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred_BF</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="compute-error">Compute error</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y_pred_BF_for_confusionMatrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_BF_realValues</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_pred_BF_realValues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_pred_BF_for_confusionMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_pred_BF_for_confusionMatrix</span> <span class="o">==</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y_test_for_confusionMatrix</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_BF_for_confusionMatrix</span><span class="p">)</span>

<span class="n">errorOnTestSetBF</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Time for finding the best ANN by Black Fox service is "</span><span class="p">,</span> <span class="n">time3</span><span class="p">,</span><span class="s">"seconds("</span><span class="p">,</span><span class="n">hours3</span><span class="p">,</span><span class="s">"hours,"</span><span class="p">,</span><span class="n">minutes3</span><span class="p">,</span><span class="s">"minutes and "</span><span class="p">,</span><span class="n">seconds3</span><span class="p">,</span><span class="s">"seconds)."</span><span class="p">)</span>

<span class="c1"># CONFUSION MATRIX IMAGE
</span><span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                          <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Normalized confusion matrix'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">'Confusion matrix, without normalization'</span>

    <span class="c1"># Compute confusion matrix
</span>    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="c1"># Only use the labels that appear in the data
</span>    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float'</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#print("Normalized confusion matrix")
</span>    <span class="c1">#else:
</span>        <span class="c1">#print('Confusion matrix, without normalization')
</span>
    <span class="c1">#print(cm)
</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
    
    <span class="c1"># We want to show all ticks...
</span>    <span class="n">ax</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
           <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
           <span class="c1"># ... and label them with the respective list entries
</span>           <span class="n">xticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
           <span class="n">ylabel</span><span class="o">=</span><span class="s">'True label'</span><span class="p">,</span>
           <span class="n">xlabel</span><span class="o">=</span><span class="s">'Predicted label'</span><span class="p">)</span>

    <span class="c1"># Rotate the tick labels and set their alignment.
</span>    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">"right"</span><span class="p">,</span>
             <span class="n">rotation_mode</span><span class="o">=</span><span class="s">"anchor"</span><span class="p">)</span>

    <span class="c1"># Loop over data dimensions and create text annotations.
</span>    <span class="n">fmt</span> <span class="o">=</span> <span class="s">'.2f'</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s">'d'</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fmt</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">"center"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s">"white"</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="s">"black"</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#plt.savefig("Churn_grafici/grafik_4.png")
</span>    <span class="c1">#plt.savefig("Churn_grafici/grafik_4.svg")
</span>    <span class="k">return</span> <span class="n">ax</span>


<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">"Not Exited"</span><span class="p">,</span><span class="s">"Exited"</span><span class="p">])</span>
<span class="c1"># Plot non-normalized confusion matrix
</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test_for_confusionMatrix</span><span class="p">,</span> <span class="n">y_pred_BF_for_confusionMatrix</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Confusion matrix'</span><span class="p">);</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Test set error for finding the best ANN by Black Fox service, which we can read in confusion matrix is"</span><span class="p">,</span><span class="n">errorOnTestSetBF</span><span class="p">,</span><span class="s">"</span><span class="si">%</span><span class="s">."</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time for finding the best ANN by Black Fox service is  5670 seconds( 1 hours, 34 minutes and  30 seconds).

Test set error for finding the best ANN by Black Fox service, which we can read in confusion matrix is 14.7 %.
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_49_1.png" alt="png" /></p>

<h4 id="roc-curve-and-auc-2">ROC curve and AUC</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># roc curve and auc
</span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># calculate AUC
</span><span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_BF_realValues</span><span class="p">)</span>
<span class="c1"># calculate roc curve
</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_BF_realValues</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Random ROC'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Black Fox ROC (AUC = </span><span class="si">%.3</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'ROC Curve'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'False Posive rate (FPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'True Posive rate (TPR)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="s">'lower right'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_51_0.png" alt="png" /></p>

<h1 id="results-and-discussion">RESULTS AND DISCUSSION</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Comparison
</span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="n">auc_manual</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_trained</span><span class="p">)</span>
<span class="n">auc_tuned</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tuning</span><span class="p">)</span>
<span class="n">auc_BF</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_BF_realValues</span><span class="p">)</span>

<span class="n">fpr_manual</span><span class="p">,</span> <span class="n">tpr_manual</span><span class="p">,</span> <span class="n">thresholds_manual</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_trained</span><span class="p">)</span>
<span class="n">fpr_tuned</span><span class="p">,</span> <span class="n">tpr_tuned</span><span class="p">,</span> <span class="n">thresholds_tuned</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_tuning</span><span class="p">)</span>
<span class="n">fpr_BF</span><span class="p">,</span> <span class="n">tpr_BF</span><span class="p">,</span> <span class="n">thresholds_BF</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_BF_realValues</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Random ROC'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_manual</span><span class="p">,</span> <span class="n">tpr_manual</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Manual ROC (AUC = </span><span class="si">%.4</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc_manual</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_tuned</span><span class="p">,</span> <span class="n">tpr_tuned</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Tuning ROC (AUC = </span><span class="si">%.4</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc_tuned</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'orange'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_BF</span><span class="p">,</span> <span class="n">tpr_BF</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Black Fox ROC (AUC = </span><span class="si">%.4</span><span class="s">f)'</span> <span class="o">%</span> <span class="n">auc_BF</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'ROC Curve - Comparison'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'False Posive rate (FPR)'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'True Posive rate (TPR)'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'lower right'</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_53_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">'font'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">'8'</span><span class="p">)</span>

<span class="n">n_groups</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">group_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Human_time1</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">Human_time2</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">Human_time3</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">group_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">time1</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">time2</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">time3</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">group_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">errorOnTestSetTrained</span><span class="p">,</span> <span class="n">errorOnTestSetTuning</span><span class="p">,</span> <span class="n">errorOnTestSetBF</span><span class="p">)</span>

<span class="c1"># Create plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_groups</span><span class="p">)</span>
<span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">space</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">opacity</span> <span class="o">=</span> <span class="mi">1</span>


<span class="n">rects1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">group_1</span><span class="p">,</span> <span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'orange'</span><span class="p">,</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
<span class="n">label</span><span class="o">=</span><span class="s">'Human effort ( h )'</span><span class="p">)</span>

<span class="n">rects2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">group_2</span><span class="p">,</span> <span class="n">bar_width</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span><span class="n">group_1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.77</span><span class="p">),</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
<span class="n">label</span><span class="o">=</span><span class="s">'Execution time ( h )'</span><span class="p">)</span>

<span class="n">rects3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">bar_width</span><span class="o">+</span><span class="n">space</span><span class="p">,</span> <span class="n">group_3</span><span class="p">,</span> <span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span><span class="p">,</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
<span class="n">label</span><span class="o">=</span><span class="s">'Error ( </span><span class="si">% </span><span class="s">)'</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Comparison'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">bar_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">space</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">'Manual'</span><span class="p">,</span> <span class="s">'Optimized'</span><span class="p">,</span> <span class="s">'Black Fox service'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.376</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">))</span>
 
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Churn_Black_Fox_5k_files/Churn_Black_Fox_5k_54_0.png" alt="png" /></p>

<h4 id="although-we-measured-this-three-options-actually-they-are-not-so-comparable-because-in-python-we-had-a-man-sitting-in-office-and-programming-those-neural-networks-options-1-and-2-while-in-black-fox-service-option-3-he-imported-the-same-data-set-and-the-service-did-the-rest-while-he-went-to-rest-or-dring-coffe-for-example-so-actually-in-black-fox-service-he-wrote-few-lines-of-code-and-thats-all-of-hard-work-results-in-the-given-plots-above-speak-for-themself-as-you-can-see-black-fox-service-gave-better-results-in-less-time-and-effort-to-create-approximate-results-in-python-as-black-fox-did-is-immeasurably-large">Although we measured this three options, actually they are not so comparable, because in Python we had a man sitting in office and programming those neural networks (options 1 and 2) while in Black Fox service (option 3), he imported the same data set and the service did the rest, while he went to rest or dring coffe, for example, so actually, in Black Fox service he wrote few lines of code and thats all of hard work. Results in the given plots above speak for themself. As you can see, Black Fox service gave better results in less time and effort to create approximate results in Python as Black Fox did is immeasurably large.</h4>



        </div>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blackfox-examples/examples/churn/" class="pagination--pager" title="Churn Example
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>
  <div>
    <a href="../jupyter/Churn_Black_Fox_5k.ipynb" download>Jupyter notebook</a><br/>
    <a href="../jupyter/Churn_Black_Fox_5k.md" download>Markdown</a>
  </div>

  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="search" id="search" aria-placeholder="Enter your search term..." class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>

      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://github.com/vodena" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/blackfox-examples/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 VodÃ©na. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blackfox-examples/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js" integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ" crossorigin="anonymous"></script>




<script src="/blackfox-examples/assets/js/lunr/lunr.min.js"></script>
<script src="/blackfox-examples/assets/js/lunr/lunr-store.js"></script>
<script src="/blackfox-examples/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
